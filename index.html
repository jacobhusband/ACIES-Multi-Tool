<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Projects</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        (function () {
            try {
                const stored = localStorage.getItem('acies-theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const theme = stored || (prefersDark ? 'dark' : 'light');
                document.documentElement.setAttribute('data-theme', theme);
            } catch (e) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div id="appLoader" class="app-loader" role="status" aria-live="polite" aria-label="Loading">
        <div class="app-loader-content">
            <img src="./acies.png" alt="ACIES" class="app-loader-logo" onerror="this.style.display='none'" />
            <div class="app-loader-dots" aria-hidden="true">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </div>
    <header class="app-header">
        <div class="brand">
            <img src="./acies.png" alt="ACIES" class="logo-img" onerror="this.style.display='none'" />
        </div>
        <!-- Centered navigation -->
        <div class="header-center">
            <nav class="main-nav">
                <button class="main-tab-btn active" data-tab="projects">Projects</button>
                <button class="main-tab-btn" data-tab="notes">Notes</button>
                <button class="main-tab-btn" data-tab="tools">Tools</button>
                <button class="main-tab-btn" data-tab="plugins">Plugins</button>
            </nav>
        </div>
        <div class="header-actions">
            <div class="version-chip" id="versionChip" title="Current version">
                <span class="version-dot" id="versionDot"></span>
                <span id="appVersionLabel">v0.0.0</span>
                <button class="icon-btn mini" id="checkUpdateBtn" aria-label="Check for updates"
                    title="Check for updates">
                    <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true" focusable="false">
                        <path fill="currentColor"
                            d="M12 4a8 8 0 1 0 7.45 10.67 1 1 0 1 1 1.9.66A10 10 0 1 1 12 2a1 1 0 1 1 0 2Zm6.71-3.29a1 1 0 0 0-1.42 0l-3 3a1 1 0 0 0 1.42 1.42L17 5.41V10a1 1 0 1 0 2 0V3.41l1.29 1.3a1 1 0 0 0 1.42-1.42Z" />
                    </svg>
                </button>
            </div>
            <button class="btn btn-primary tiny" id="appUpdateBtn" style="display:none;">Update</button>
            <button class="icon-btn theme-toggle" id="themeToggleBtn" aria-label="Toggle theme"
                title="Toggle light/dark mode">‚òÄÔ∏è</button>
            <button class="icon-btn" id="settingsBtn" aria-label="Settings" title="Settings">‚öôÔ∏è</button>
            <button class="icon-btn" id="mainHelpBtn" aria-label="Help" title="Help">?</button>
        </div>
    </header>
    <!-- Setup Help Notification -->
    <div id="setupHelpBanner" class="setup-help-banner" style="display: none;">
        <div class="setup-help-content">
            <div class="setup-help-icon">üí°</div>
            <div class="setup-help-text">
                <strong>Need help setting up the application?</strong>
                <p>Configure your profile and API keys to get the most out of this application.</p>
            </div>
            <div class="setup-help-actions">
                <button class="btn btn-primary tiny" onclick="startSetupHelp()">Yes</button>
                <button class="btn ghost tiny" onclick="dismissSetupHelp('later')">Not right now</button>
                <button class="btn ghost tiny" onclick="dismissSetupHelp('never')">Do not ask again</button>
            </div>
            <button class="setup-help-close" onclick="dismissSetupHelp('later')" aria-label="Close">√ó</button>
        </div>
    </div>
    <main>
        <!-- Tab Panel for Projects -->
        <div id="projects-panel" class="tab-panel active">
            <section class="panel stack">
                <div class="panel-toolbar">
                    <div class="nav-search expanded-search">
                        <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <input id="search" type="search" placeholder="Search projects..." />
                    </div>
                    <div class="toolbar-actions">
                        <button class="btn tiny" id="mergeProjectsBtn" disabled>Merge</button>
                        <button class="icon-btn quick-add" id="quickNew" aria-label="New project"
                            title="New project">Ôºã</button>
                        <button class="icon-btn" id="aiBtn" aria-label="AI Project"
                            title="Create project with AI">ü§ñ</button>
                        <button class="icon-btn" id="statsBtn" aria-label="Statistics"
                            title="View Statistics">üìä</button>
                        <button class="icon-btn" id="projectsHelpBtn" aria-label="Projects help"
                            title="Projects help">?</button>
                    </div>
                </div>
                <div class="filter-controls">
                    <div class="filter-label">Timeframe</div>
                    <div class="due-filter-group" id="dueFilterGroup">
                        <button class="filter-chip active" data-due-filter="all">All</button>
                        <button class="filter-chip" data-due-filter="past">Past Weeks</button>
                        <button class="filter-chip" data-due-filter="soon">This Week</button>
                        <button class="filter-chip" data-due-filter="future">Upcoming Weeks</button>
                    </div>
                    <div class="filter-label" style="margin-top:0.5rem">Status</div>
                    <div class="status-filter-group" id="statusFilterGroup">
                        <button class="filter-chip active" data-filter="all">All</button>
                        <button class="filter-chip" data-filter="incomplete">Incomplete</button>
                        <button class="filter-chip" data-filter="Waiting">Waiting</button>
                        <button class="filter-chip" data-filter="Working">Working</button>
                        <button class="filter-chip" data-filter="Pending Review">Pending Review</button>
                        <button class="filter-chip" data-filter="Complete">Complete</button>
                        <button class="filter-chip" data-filter="Delivered">Delivered</button>
                    </div>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th class="cell-select">
                                <input type="checkbox" id="projectsSelectAll" aria-label="Select all projects"
                                    style="width:auto">
                            </th>
                            <th style="width:90px" data-sort="id">ID</th>
                            <th data-sort="name">Project Details</th>
                            <th class="deliverables-header" data-sort="due" colspan="3">Deliverables</th>
                            <th class="nowrap" style="width:120px;text-align:center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tbody"></tbody>
                </table>
                <div id="emptyState" class="empty" style="display:none">
                    <div class="empty-icon">üìÇ</div>
                    <h3>No projects yet</h3>
                    <p>Create a new project to get started.</p>
                </div>
            </section>
        </div>
        <!-- Tab Panel for Notes -->
        <div id="notes-panel" class="tab-panel" hidden>
            <div class="panel stack full-height">
                <div class="panel-toolbar">
                    <div class="nav-search expanded-search">
                        <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                        </svg>
                        <input id="notesSearch" type="search" placeholder="Search notes..." />
                    </div>
                    <div class="toolbar-actions">
                        <button class="icon-btn" id="notesHelpBtn" aria-label="Notes help" title="Notes help">?</button>
                    </div>
                </div>
                <div class="notes-controls">
                    <h3 class="section-title">Custom Notes</h3>
                    <div class="notes-user-tabs-row">
                        <nav class="inner-tabs" id="notesTabsContainer"></nav>
                        <!-- Add/Remove buttons moved inside inner-tabs via JS -->
                    </div>
                </div>
                <div class="inner-tab-content">
                    <textarea id="notesTextarea" class="notes-textarea"
                        placeholder="Select a page to start writing notes..."></textarea>
                </div>
                <!-- Search Results Container -->
                <div id="notesSearchResults" class="notes-search-results"></div>
            </div>
        </div>
        <!-- Tab Panel for Tools -->
        <div id="tools-panel" class="tab-panel" hidden>
            <section class="panel stack">
                <div class="tools-panel-header">
                    <div class="tools-panel-heading">
                        <h3 class="section-title">Tools</h3>
                        <p class="tiny muted">Utilities and automation tools for ACIES workflows.</p>
                    </div>
                    <div class="toolbar-actions">
                        <button class="icon-btn" id="toolsHelpBtn" aria-label="Tools help" title="Tools help">?</button>
                        <button id="abortBtn" class="btn btn-danger" style="display: none;">‚èπ Abort Process</button>
                    </div>
                </div>

                <div class="tools-section">
                    <div class="tools-section-header">
                        <h4 class="tools-section-title">General</h4>
                        <p class="tiny muted tools-section-desc">Shared tools for any discipline.</p>
                    </div>
                    <div class="tools-grid">
                        <!-- Card 1: Publish DWGs -->
                        <div id="toolPublishDwgs" class="tool-card" role="button" tabindex="0">
                            <div class="tool-card-content">
                                <div class="tool-icon">üñ®Ô∏è</div>
                                <div class="tool-card-header">Publish CAD DWGs in Headless Mode</div>
                                <div class="tool-card-body">
                                    Plots the layouts of each of the selected DWG files and combines them. Outputs to
                                    local path "user/document/AutoCAD Plots". Opens output folder with plotted PDFs.
                                </div>
                            </div>
                            <div class="tool-card-status"></div>
                        </div>
                        <!-- Card 2: Freeze Layers -->
                        <div id="toolFreezeLayers" class="tool-card" role="button" tabindex="0">
                            <div class="tool-card-content">
                                <div class="tool-icon">‚ùÑÔ∏è</div>
                                <div class="tool-card-header">Freeze Layers in CAD DWGs Headless Mode</div>
                                <div class="tool-card-body">
                                    Scans selected DWGs for layers, lets you freeze or thaw them, then saves updates in
                                    headless mode.
                                </div>
                            </div>
                            <div class="tool-card-status"></div>
                        </div>
                        <!-- Card 3: Clean XREFs -->
                        <div id="toolCleanXrefs" class="tool-card" role="button" tabindex="0">
                            <div class="tool-card-content">
                                <div class="tool-icon">üßπ</div>
                                <div class="tool-card-header">Prepare CAD DWG for Reference</div>
                                <div class="tool-card-body">
                                    Strips saved XREF paths. Sets all objects color to "by layer". Purges & Audits.
                                </div>
                            </div>
                            <div class="tool-card-status"></div>
                        </div>
                    </div>
                </div>

                <div class="tools-section">
                    <div class="tools-section-header">
                        <h4 class="tools-section-title">Electrical</h4>
                        <p class="tiny muted tools-section-desc">Calculators and electrical utilities.</p>
                    </div>
                    <div class="tools-grid">
                        <div id="toolWireSizer" class="tool-card" role="button" tabindex="0">
                            <div class="tool-card-content">
                                <div class="tool-icon">‚ö°</div>
                                <div class="tool-card-header">Wire Sizer</div>
                                <div class="tool-card-body">
                                    Size conductors, voltage drop, and conduit fill with the ACIES wire sizing tool.
                                </div>
                            </div>
                            <div class="tool-card-status"></div>
                        </div>
                        <div id="toolLightingSchedule" class="tool-card" role="button" tabindex="0">
                            <div class="tool-card-content">
                                <div class="tool-icon">LF</div>
                                <div class="tool-card-header">Light Fixture Scheduler</div>
                                <div class="tool-card-body">
                                    Build and store lighting fixture schedules for each project.
                                </div>
                            </div>
                            <div class="tool-card-status"></div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        <!-- Tab Panel for Plugins -->
        <div id="plugins-panel" class="tab-panel" hidden>
            <section class="panel stack">
                <!-- Unified Commands Section -->
                <div class="commands-section">
                    <div class="commands-header">
                        <div>
                            <h3 class="section-title">AutoCAD Plugins</h3>
                            <p class="tiny muted">Install, update, or uninstall command bundles.</p>
                        </div>
                        <div class="toolbar-actions">
                            <button class="icon-btn" id="pluginsHelpBtn" aria-label="Plugins help"
                                title="Plugins help">?</button>
                        </div>
                    </div>
                    <div id="commands-container" class="tools-grid">
                        <!-- Command cards will be dynamically inserted here -->
                        <div class="spinner">Loading commands...</div>
                    </div>
                </div>
            </section>
        </div>
    </main>
    <!-- Edit / New Modal -->
    <dialog id="editDlg">
        <div class="modal-header">
            <div id="dlgTitle" class="title">Edit Project</div>
            <div class="inline">
                <button class="btn ghost" onclick="closeDlg('editDlg')">Cancel</button>
                <button class="btn-primary" id="btnSaveProject">Save Changes</button>
            </div>
        </div>
        <div class="modal-body stack">
            <div class="modal-grid">
                <div class="col-4">
                    <label class="label">Project ID</label>
                    <input id="f_id" placeholder="e.g. 250410" />
                </div>
                <div class="col-8">
                    <label class="label">Project Name</label>
                    <input id="f_name" placeholder="BofA, 121 Windward Ave., Venice, CA" />
                </div>
                <div class="col-4">
                    <label class="label">Nickname</label>
                    <input id="f_nick" placeholder="optional" />
                </div>
                <div class="col-8">
                    <label class="label">Project Path</label>
                    <input id="f_path" placeholder="e.g. M:\Projects\..." />
                </div>
                <div class="col-12">
                    <label class="label">Global Notes</label>
                    <textarea id="f_notes" rows="3" placeholder="Global notes"></textarea>
                </div>
            </div>
            <div class="section-divider"></div>
            <div class="stack">
                <div class="inline" style="justify-content:space-between">
                    <div class="title section-header">Deliverables</div>
                    <button class="btn-accent tiny" onclick="addDeliverable()">+ Add Deliverable</button>
                </div>
                <div id="deliverableList" class="stack"></div>
            </div>
            <div class="section-divider"></div>
            <div class="stack">
                <div class="inline" style="justify-content:space-between">
                    <div class="title section-header">Reference Links</div>
                    <button class="btn-accent tiny" onclick="addRefRow()">Ôºã Add Link</button>
                </div>
                <div id="refList" class="stack"></div>
            </div>
        </div>
    </dialog>
    <!-- Email Modal -->
    <dialog id="emailDlg">
        <div class="modal-header">
            <div class="title">Create from Email</div>
            <div class="inline">
                <button class="btn ghost" onclick="closeDlg('emailDlg')">Cancel</button>
                <button class="btn-primary" id="btnProcessEmail">Process with AI</button>
            </div>
        </div>
        <div class="modal-body stack">
            <p class="tiny muted">Paste the full email content below. The AI will extract the project details.</p>
            <textarea id="emailArea" rows="15" placeholder="Paste email content here‚Ä¶"></textarea>
            <div id="aiSpinner" class="spinner" style="display:none;">Processing with AI...</div>
        </div>
    </dialog>
    <!-- Paste CSV Modal -->
    <dialog id="pasteDlg">
        <div class="modal-header">
            <div class="title">Paste CSV</div>
            <div class="inline">
                <button class="btn ghost" onclick="closeDlg('pasteDlg')">Close</button>
                <button class="btn-primary" id="btnPasteImport">Import</button>
            </div>
        </div>
        <div class="modal-body stack">
            <div class="tiny muted">Expected columns: <b>ID, Project Name, Nickname, Deliverable Notes, Due Date, Status, Tasks,
                    Path, Reference1, Reference2</b></div>
            <textarea id="pasteArea" rows="12" placeholder="Paste rows from Excel/CSV here‚Ä¶"></textarea>
            <label class="inline tiny checkbox-label"><input type="checkbox" id="hasHeader" checked style="width:auto">
                First row
                contains headers</label>
        </div>
    </dialog>
    <!-- Delete All Confirmation Modal -->
    <dialog id="deleteDlg" class="danger-modal">
        <div class="modal-body stack centered-content">
            <div class="danger-icon-large">‚ö†Ô∏è</div>
            <h2 class="danger-heading">Delete All Projects?</h2>
            <p class="muted">This action is irreversible. All project data will be permanently lost.</p>

            <div class="confirmation-box">
                <label class="label" style="text-align:center">Type <b>DELETE</b> to confirm</label>
                <input id="deleteConfirmInput" type="text" placeholder="DELETE" autocomplete="off"
                    class="danger-input" />
            </div>

            <div class="modal-footer-simple">
                <button class="btn ghost" onclick="closeDlg('deleteDlg')">Cancel</button>
                <button class="btn-danger" id="btnDeleteConfirm" disabled>Delete All Data</button>
            </div>
        </div>
    </dialog>
    <!-- Mark Overdue Confirmation Modal -->
    <dialog id="markOverdueDlg">
        <div class="modal-header">
            <div class="title">Mark Past Due Deliverables as Complete</div>
            <button class="btn ghost" onclick="closeDlg('markOverdueDlg')">Cancel</button>
        </div>
        <div class="modal-body stack">
            <p>This will change the status of all deliverables with a due date before today to "Complete".</p>
            <p>Are you sure you want to proceed?</p>
            <div class="inline" style="justify-content: flex-end; gap: 1rem;">
                <button class="btn ghost" onclick="closeDlg('markOverdueDlg')">Cancel</button>
                <button class="btn-primary" id="btnConfirmMarkOverdue">Yes, Mark as Complete</button>
            </div>
        </div>
    </dialog>
    <!-- Mark Overdue as Delivered Confirmation Modal -->
    <dialog id="markOverdueDeliveredDlg">
        <div class="modal-header">
            <div class="title">Mark Past Due Deliverables as Delivered</div>
            <button class="btn ghost" onclick="closeDlg('markOverdueDeliveredDlg')">Cancel</button>
        </div>
        <div class="modal-body stack">
            <p>This will change the status of all deliverables with a due date before today to "Delivered".</p>
            <p>Are you sure you want to proceed?</p>
            <div class="inline" style="justify-content: flex-end; gap: 1rem;">
                <button class="btn ghost" onclick="closeDlg('markOverdueDeliveredDlg')">Cancel</button>
                <button class="btn-primary" id="btnConfirmMarkOverdueDelivered">Yes, Mark as Delivered</button>
            </div>
        </div>
    </dialog>
    <!-- Delete All Notes Confirmation Modal -->
    <dialog id="deleteNotesDlg" class="danger-modal">
        <div class="modal-body stack centered-content">
            <div class="danger-icon-large">‚ö†Ô∏è</div>
            <h2 class="danger-heading">Delete All Notes?</h2>
            <p class="muted">This will delete all stored notes and custom pages. This cannot be undone.</p>

            <div class="confirmation-box">
                <label class="label" style="text-align:center">Type <b>DELETE</b> to confirm</label>
                <input id="deleteNotesConfirmInput" type="text" placeholder="DELETE" autocomplete="off"
                    class="danger-input" />
            </div>

            <div class="modal-footer-simple">
                <button class="btn ghost" onclick="closeDlg('deleteNotesDlg')">Cancel</button>
                <button class="btn-danger" id="btnDeleteNotesConfirm" disabled>Delete All Notes</button>
            </div>
        </div>
    </dialog>
    <!-- Uninstall All Plugins Confirmation Modal -->
    <dialog id="uninstallPluginsDlg" class="danger-modal">
        <div class="modal-body stack centered-content">
            <div class="danger-icon-large">‚ö†Ô∏è</div>
            <h2 class="danger-heading">Uninstall All Plugins?</h2>
            <p class="muted">This will remove all installed AutoCAD plugins from your system.</p>

            <div class="confirmation-box">
                <label class="label" style="text-align:center">Type <b>UNINSTALL</b> to confirm</label>
                <input id="uninstallPluginsConfirmInput" type="text" placeholder="UNINSTALL" autocomplete="off"
                    class="danger-input" />
            </div>

            <div class="modal-footer-simple">
                <button class="btn ghost" onclick="closeDlg('uninstallPluginsDlg')">Cancel</button>
                <button class="btn-danger" id="btnUninstallPluginsConfirm" disabled>Uninstall All</button>
            </div>
        </div>
    </dialog>
    <!-- Settings Modal -->
    <dialog id="settingsDlg">
        <div class="modal-header">
            <div class="title">Settings</div>
            <button class="btn ghost" onclick="closeDlg('settingsDlg')">Close</button>
        </div>
        <div class="modal-body stack">
            <!-- General Section -->
            <h3 class="section-title">General</h3>
            <div class="modal-grid">
                <div class="col-6">
                    <label class="label">Full Name</label>
                    <input id="settings_userName" placeholder="e.g. Jacob Husband" />
                </div>
                <div class="col-6">
                    <label class="label">Discipline</label>
                    <div id="settings_discipline" class="inline radio-group" style="height: 38px; align-items: center;">
                        <label class="radio-label"><input type="checkbox" name="settings_discipline_checkbox"
                                value="Electrical"> Electrical</label>
                        <label class="radio-label"><input type="checkbox" name="settings_discipline_checkbox"
                                value="Mechanical"> Mechanical</label>
                        <label class="radio-label"><input type="checkbox" name="settings_discipline_checkbox"
                                value="Plumbing"> Plumbing</label>
                    </div>
                </div>
            </div>

            <!-- Integrations Section -->
            <h3 class="section-title" style="margin-top: 1rem;">Integrations</h3>
            <div class="modal-grid">
                <div class="col-12">
                    <label class="label">Google Gemini API Key</label>
                    <div class="input-with-button">
                        <input id="settings_apiKey" type="password" placeholder="Enter your API key" />
                        <button type="button" class="btn tiny" id="settings_howToSetupBtn">Help</button>
                    </div>
                </div>
            </div>

            <!-- AutoCAD Version Section -->
            <h3 class="section-title" style="margin-top: 1rem;">AutoCAD Version</h3>
            <div class="modal-grid">
                <div class="col-12">
                    <label class="label">Select Preferred AutoCAD Version</label>
                    <div id="autocad_versions_container" class="radio-group" style="flex-wrap: wrap;">
                        <!-- Detected versions will be inserted here -->
                    </div>
                    <div class="input-with-button" style="margin-top: 0.5rem;">
                        <input id="settings_autocadPath" placeholder="Custom AutoCAD executable path..." readonly />
                        <button class="btn tiny" id="btnBrowseAutocad">Browse...</button>
                    </div>
                </div>
            </div>

            <!-- Actions Section -->
            <h3 class="section-title" style="margin-top: 1rem;">Actions</h3>
            <div class="stack">
                <div class="setting-row">
                    <div class="setting-info">
                        <div class="setting-label">Run Setup Guide</div>
                        <div class="setting-desc">Launch the 4-step introduction to configure your name, discipline, and
                            API key.</div>
                    </div>
                    <button class="btn" id="btnStartSetupGuide">Start Guide</button>
                </div>
                <div class="setting-row">
                    <div class="setting-info">
                        <div class="setting-label">Mark Overdue as Complete</div>
                        <div class="setting-desc">Change status of all past due projects to "Complete"</div>
                    </div>
                    <button class="btn" id="btnMarkOverdue">Run Action</button>
                </div>
                <div class="setting-row">
                    <div class="setting-info">
                        <div class="setting-label">Mark Overdue as Delivered</div>
                        <div class="setting-desc">Change status of all past due projects to "Delivered"</div>
                    </div>
                    <button class="btn" id="btnMarkOverdueDelivered">Run Action</button>
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="danger-zone">
                <h3 class="danger-title">Danger Zone</h3>

                <div class="danger-row">
                    <div class="danger-info">
                        <div class="danger-label">Delete All Projects</div>
                        <div class="danger-desc">Permanently remove all project data. This cannot be undone.</div>
                    </div>
                    <button class="btn btn-danger" id="btnDeleteAll">Delete Projects</button>
                </div>

                <div class="danger-divider"></div>

                <div class="danger-row">
                    <div class="danger-info">
                        <div class="danger-label">Delete All Notes</div>
                        <div class="danger-desc">Permanently remove all notes and pages.</div>
                    </div>
                    <button class="btn btn-danger" id="btnDeleteAllNotes">Delete Notes</button>
                </div>

                <div class="danger-divider"></div>

                <div class="danger-row">
                    <div class="danger-info">
                        <div class="danger-label">Uninstall Plugins</div>
                        <div class="danger-desc">Remove all installed AutoCAD plugins.</div>
                    </div>
                    <button class="btn btn-danger" id="btnUninstallAllPlugins">Uninstall Plugins</button>
                </div>
            </div>

            <p class="tiny muted" style="margin-top: 1rem;">Settings are saved automatically.</p>
        </div>
    </dialog>
    <!-- Onboarding Modal -->
    <dialog id="onboardingDlg">
        <div class="modal-header">
            <div id="onboardingTitle" class="title">Welcome to ACIES!</div>
            <button class="btn ghost" onclick="skipOnboarding()">Skip Setup</button>
        </div>
        <div class="onboarding-progress">
            <div class="progress-step active" data-step="1"></div>
            <div class="progress-step" data-step="2"></div>
            <div class="progress-step" data-step="3"></div>
            <div class="progress-step" data-step="4"></div>
        </div>
        <div class="modal-body stack">
            <!-- Step 1: Welcome -->
            <div id="onboardingStep1" class="onboarding-step active">
                <div class="onboarding-content">
                    <div class="onboarding-icon">üöÄ</div>
                    <h2>Welcome to ACIES Desktop Application</h2>
                    <p>Your project management tool for engineering workflows. Let's get you set up with a few quick
                        steps.</p>
                    <div class="onboarding-features">
                        <div class="feature-item">
                            <span class="feature-icon">üìã</span>
                            <span>Manage projects and tasks</span>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">ü§ñ</span>
                            <span>AI-powered email processing</span>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">üîß</span>
                            <span>AutoCAD automation tools</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Full Name -->
            <div id="onboardingStep2" class="onboarding-step">
                <div class="onboarding-content">
                    <div class="onboarding-icon">üë§</div>
                    <h2>What's your full name?</h2>
                    <p>This helps personalize your experience and is used in AI processing.</p>
                    <div class="onboarding-input-group">
                        <label class="label">Full Name</label>
                        <input id="onboarding_userName" type="text" placeholder="e.g. Jacob Husband" />
                    </div>
                </div>
            </div>

            <!-- Step 3: Discipline -->
            <div id="onboardingStep3" class="onboarding-step">
                <div class="onboarding-content">
                    <div class="onboarding-icon">‚ö°</div>
                    <h2>What's your engineering discipline?</h2>
                    <p>This helps tailor AI responses to your specific field of work.</p>
                    <div class="onboarding-input-group">
                        <label class="label">Discipline</label>
                        <div id="onboarding_discipline" class="radio-group">
                            <label class="radio-label"><input type="checkbox" name="onboarding_discipline_checkbox"
                                    value="Electrical"> Electrical</label>
                            <label class="radio-label"><input type="checkbox" name="onboarding_discipline_checkbox"
                                    value="Mechanical"> Mechanical</label>
                            <label class="radio-label"><input type="checkbox" name="onboarding_discipline_checkbox"
                                    value="Plumbing"> Plumbing</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 4: API Key -->
            <div id="onboardingStep4" class="onboarding-step">
                <div class="onboarding-content">
                    <div class="onboarding-icon">üîë</div>
                    <h2>Set up your AI assistant</h2>
                    <p>Add your Google Gemini API key to enable AI features like email processing and project creation.
                    </p>
                    <div class="onboarding-input-group">
                        <label class="label">Google Gemini API Key</label>
                        <div class="input-with-button">
                            <input id="onboarding_apiKey" type="password" placeholder="Enter your API key" />
                            <button type="button" class="btn tiny" onclick="showApiKeyHelp()">Help</button>
                        </div>
                        <p class="tiny muted">Your API key is stored locally and never sent to our servers.</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn ghost" id="onboardingPrevBtn" onclick="prevOnboardingStep()" disabled>Previous</button>
            <button class="btn-primary" id="onboardingNextBtn" onclick="nextOnboardingStep()">Next</button>
        </div>
    </dialog>
    <!-- AutoCAD Selection Modal -->
    <dialog id="autocadSelectDlg">
        <div class="modal-header">
            <div class="title">Select AutoCAD Version</div>
            <button class="btn ghost" onclick="closeDlg('autocadSelectDlg')">Cancel</button>
        </div>
        <div class="modal-body stack">
            <p class="tiny muted">Please select your preferred AutoCAD version to use with the tools.</p>
            <div class="modal-grid">
                <div class="col-12">
                    <label class="label">Detected Versions</label>
                    <div id="autocad_select_container" class="radio-group" style="flex-wrap: wrap;">
                        <!-- Detected versions will be inserted here -->
                    </div>
                    <div class="input-with-button" style="margin-top: 0.5rem;">
                        <input id="autocad_select_custom" placeholder="Custom AutoCAD executable path..." readonly />
                        <button class="btn tiny" id="btnBrowseAutocadSelect">Browse...</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-primary" id="btnSaveAutocadSelect">Save Selection</button>
            </div>
        </div>
    </dialog>
    <!-- Statistics Modal -->
    <dialog id="statsDlg">
        <div class="modal-header">
            <div class="title">Project Statistics</div>
            <button class="btn ghost" onclick="closeDlg('statsDlg')">Close</button>
        </div>
        <div class="modal-body stack">
            <!-- Graph View (Always Visible) -->
            <div class="stats-graph-container">
                <canvas id="statsChart" width="400" height="200"></canvas>
            </div>

            <!-- Controls -->
            <div class="filter-controls" style="margin-bottom: 1rem;">
                <div class="modal-grid">
                    <div class="col-6">
                        <div class="filter-label">Timeframe</div>
                        <div class="due-filter-group" id="statsRangeGroup">
                            <button class="filter-chip" data-range="1W">1 Week</button>
                            <button class="filter-chip" data-range="1M">1 Month</button>
                            <button class="filter-chip active" data-range="1Y">1 Year</button>
                            <button class="filter-chip" data-range="3Y">3 Years</button>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="filter-label">Aggregation</div>
                        <div class="status-filter-group" id="statsAggGroup">
                            <button class="filter-chip" data-agg="day">Days</button>
                            <button class="filter-chip" data-agg="week">Weeks</button>
                            <button class="filter-chip active" data-agg="month">Months</button>
                            <button class="filter-chip" data-agg="quarter">Quarters</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Numbers Grid (Always Visible) -->
            <div class="stats-grid">
                <div class="stats-section-title">Overview & History</div>
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-value" id="statTotal">0</div>
                    <div class="stat-label">Total Deliverables</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-value" id="statCompleted">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìà</div>
                    <div class="stat-value" id="statAvg">0</div>
                    <div class="stat-label">Avg Completions / Week</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìÖ</div>
                    <div class="stat-value" id="statAvgMonth">0</div>
                    <div class="stat-label">Avg Completions / Month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ö†Ô∏è</div>
                    <div class="stat-value" id="statLastWeek">0</div>
                    <div class="stat-label">Due Last Week</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìÖ</div>
                    <div class="stat-value" id="statThisWeek">0</div>
                    <div class="stat-label">Due This Week</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üîÆ</div>
                    <div class="stat-value" id="statUpcoming">0</div>
                    <div class="stat-label">Upcoming</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üèÜ</div>
                    <div class="stat-value" id="statCompletedThisYear">0</div>
                    <div class="stat-label">Done This Year</div>
                </div>
            </div>
        </div>
    </dialog>
    <!-- API Key Help Modal -->
    <dialog id="apiKeyHelpDlg">
        <div class="modal-header">
            <div class="title">Setup API Key</div>
            <button class="btn ghost" onclick="closeDlg('apiKeyHelpDlg')">Close</button>
        </div>
        <div class="modal-body stack">
            <p>To use the AI features, you need a free API key from Google AI Studio.</p>
            <ol style="margin: 0; padding-left: 1.25rem; line-height: 1.6;">
                <li>Click the button to open google API.</li>
                <li>Login to google account.</li>
                <li>Click "Create API key".</li>
                <li>Name the key your acies email (ex. jacobh@acies.net).</li>
                <li>Click "Select a Cloud Project".</li>
                <li>Click "Create project" from the dropdown.</li>
                <li>Name your project as "ACIES".</li>
                <li>Click the "Create project" button.</li>
                <li>Click "Create key" button.</li>
                <li>Click the "Copy API key" on the right side of the API key entry.</li>
                <li>Paste the copied key into the ACIES application.</li>
            </ol>
            <a href="https://aistudio.google.com/api-keys" target="_blank" class="btn-primary block-center">Open Google
                AI Studio</a>
        </div>
    </dialog>



    <!-- Install Prerequisite Modal -->
    <dialog id="installPrereqDlg">
        <div class="modal-header">
            <div id="installPrereqTitle" class="title">Installation Required</div>
            <button class="btn ghost" onclick="closeDlg('installPrereqDlg')">Cancel</button>
        </div>
        <div class="modal-body stack">
            <p id="installPrereqMessage">To use this tool, the "CleanCADCommands" bundle needs to be installed.</p>
            <div id="installSpinner" class="spinner" style="display:none;">Installing...</div>
        </div>
        <div class="modal-footer">
            <button class="btn" onclick="closeDlg('installPrereqDlg')">Later</button>
            <button class="btn-primary" id="btnInstallPrereq">Install Now</button>
        </div>
    </dialog>

    <dialog id="wireSizerDlg" class="wire-sizer-dialog">
        <div class="wire-sizer-shell">
            <div class="wire-sizer-header">
                <div class="wire-sizer-title">
                    <div class="title">Wire Sizer</div>
                    <p class="tiny muted">Electrical wire sizing and voltage drop calculator.</p>
                </div>
                <button class="icon-btn" id="wireSizerCloseBtn" aria-label="Close Wire Sizer" title="Close">X</button>
            </div>
            <div class="wire-sizer-body">
                <div id="wireSizerEmptyState" class="wire-sizer-empty" hidden></div>
                <iframe id="wireSizerFrame" class="wire-sizer-frame" title="Wire Sizer"></iframe>
            </div>
        </div>
    </dialog>

    <dialog id="lightingScheduleDlg" class="lighting-schedule-dialog">
        <div class="lighting-schedule-shell">
            <div class="lighting-schedule-header">
                <div class="lighting-schedule-title">
                    <div class="title">Light Fixture Scheduler</div>
                    <p class="tiny muted">Lighting fixture schedule by project.</p>
                </div>
                <button class="icon-btn" id="lightingScheduleCloseBtn" aria-label="Close Light Fixture Scheduler"
                    title="Close">X</button>
            </div>
            <div class="lighting-schedule-body">
                <div class="lighting-schedule-controls">
                    <div class="lighting-schedule-select">
                        <label class="label" for="lightingScheduleProjectSearch">Search Projects</label>
                        <input id="lightingScheduleProjectSearch" type="search"
                            placeholder="Search by project ID or name" />
                    </div>
                    <div class="lighting-schedule-select">
                        <label class="label" for="lightingScheduleProjectSelect">Project</label>
                        <select id="lightingScheduleProjectSelect"></select>
                    </div>
                    <div class="lighting-schedule-actions">
                        <button class="btn tiny" id="lightingScheduleAddRow" type="button">Add Row</button>
                    </div>
                </div>
                <div class="lighting-template-panel">
                    <div class="lighting-template-header">
                        <div class="lighting-template-heading">
                            <div class="lighting-template-title">Fixture Templates</div>
                            <div class="tiny muted">Save a row as a template, then search marks to add.</div>
                        </div>
                        <input id="lightingTemplateSearch" type="search" placeholder="Search mark or description" />
                    </div>
                    <div id="lightingTemplateList" class="lighting-template-list"></div>
                </div>
                <div id="lightingScheduleEmptyState" class="lighting-schedule-empty" hidden></div>
                <div id="lightingScheduleTableWrap" class="lighting-schedule-table-wrap">
                    <table class="lighting-schedule-table" aria-label="Lighting fixture schedule">
                        <thead>
                            <tr>
                                <th colspan="8" class="lighting-schedule-title-cell">LIGHTING FIXTURE SCHEDULE</th>
                            </tr>
                            <tr>
                                <th>MARK</th>
                                <th>DESCRIPTION</th>
                                <th>MANUFACTURER</th>
                                <th>MODEL NUMBER</th>
                                <th>MOUNTING</th>
                                <th>VOLTS</th>
                                <th>WATTS</th>
                                <th>NOTES</th>
                            </tr>
                        </thead>
                        <tbody id="lightingScheduleRows"></tbody>
                        <tfoot>
                            <tr>
                                <td colspan="8" class="lighting-schedule-notes-cell">
                                    <div class="lighting-schedule-notes">
                                        <div class="lighting-schedule-notes-label">GENERAL NOTES:</div>
                                        <textarea id="lightingScheduleGeneralNotes" rows="6"></textarea>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="8" class="lighting-schedule-notes-cell">
                                    <div class="lighting-schedule-notes">
                                        <div class="lighting-schedule-notes-label">NOTES:</div>
                                        <textarea id="lightingScheduleNotes" rows="4"></textarea>
                                    </div>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </dialog>

    <!-- HTML Templates for JS rendering -->
    <template id="project-row-template">
        <tr class="row">
            <td class="cell-select">
                <input type="checkbox" class="project-select" aria-label="Select project" style="width:auto">
            </td>
            <td class="cell-id"><span class="id-badge"></span></td>
            <td class="cell-name"></td>
            <td class="cell-deliverables" colspan="3"></td>
            <td class="cell-actions actions"></td>
        </tr>
    </template>
    <template id="deliverable-card-template">
        <div class="deliverable-card">
            <div class="deliverable-card-header">
                <div class="deliverable-fields">
                    <div class="field">
                        <label class="label">Deliverable Name</label>
                        <input class="d-name" placeholder="e.g. DD90" />
                    </div>
                    <div class="field">
                        <label class="label">Due Date</label>
                        <input class="d-due" placeholder="MM/DD/YY" />
                    </div>
                </div>
                <div class="deliverable-controls">
                    <label class="tiny checkbox-label"><input type="checkbox" class="d-overview"
                            style="width:auto">Show in overview</label>
                    <label class="tiny checkbox-label"><input type="radio" class="d-primary"
                            style="width:auto">Primary</label>
                    <button type="button" class="btn tiny btn-remove text-danger">Remove</button>
                </div>
            </div>
            <label class="label">Status</label>
            <div class="deliverable-status"></div>
            <label class="label">Notes</label>
            <textarea class="d-notes" rows="3" placeholder="Deliverable notes"></textarea>
            <div class="stack">
                <div class="inline" style="justify-content:space-between">
                    <div class="title section-header">Tasks</div>
                    <button type="button" class="btn-accent tiny d-add-task">+ Add Task</button>
                </div>
                <div class="deliverable-task-list stack"></div>
            </div>
        </div>
    </template>
    <template id="task-row-template">
        <div class="task-row modal-grid" style="align-items:center">
            <div class="col-8"><input class="t-text" placeholder="Task description"></div>
            <div class="col-1"><label class="tiny inline checkbox-label"><input type="checkbox" class="t-done"
                        style="width:auto">
                    Done</label></div>
            <div class="col-3 inline" style="justify-content:flex-end; gap:.4rem"><button type="button"
                    class="btn tiny btn-remove text-danger">Remove</button></div>
            <div class="col-6"><input class="t-link" placeholder="Optional link or file path"></div>
            <div class="col-6"><input class="t-link2" placeholder="Second link (optional)"></div>
        </div>
    </template>
    <template id="ref-row-template">
        <div class="ref-row modal-grid" style="align-items:center">
            <div class="col-4"><input class="r-label" placeholder="Label (optional)"></div>
            <div class="col-8"><input class="r-url" placeholder="URL or file path"></div>
            <div class="col-12 inline" style="justify-content:flex-end; gap:.4rem"><button type="button"
                    class="btn tiny btn-remove text-danger">Remove</button></div>
        </div>
    </template>
    <script src="script.js"></script>
</body>

</html>
